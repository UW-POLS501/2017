<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />



<meta name="date" content="2017-01-18" />

<title>WDI Data Analysis Example</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-1.1/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-1.1/highlight.js"></script>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs && document.readyState && document.readyState === "complete") {
   window.setTimeout(function() {
      hljs.initHighlighting();
   }, 0);
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="styles.css" type="text/css" />

</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}

.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->




<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}


.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
  padding-left: 25px;
  text-indent: 0;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>

<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">POLS/CS&SS 501</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Syllabus</a>
</li>
<li>
  <a href="schedule.html">Schedule</a>
</li>
<li>
  <a href="research_project.html">Project</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Assignments
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="assignment-1.html">Assignment 1</a>
    </li>
    <li>
      <a href="assignment-2.html">Assignment 2</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->


<div class="fluid-row" id="header">



<h1 class="title toc-ignore">WDI Data Analysis Example</h1>
<h4 class="date"><em>January 18, 2017</em></h4>

</div>


<div id="tidy-and-relational-data-with-world-development-indicators" class="section level1">
<h1>Tidy and Relational Data with World Development Indicators</h1>
<p>This is practical example of using R to clean and tidy the World Bank <a href="http://data.worldbank.org/data-catalog/world-development-indicators">World Development Indicators</a> data. This is a widely used dataset of economic, health, education, and societal indicators.</p>
<pre class="r"><code>library(&quot;tidyverse&quot;)
library(&quot;stringr&quot;)
knitr::opts_chunk$set(cache=FALSE)</code></pre>
<p>We first need to download the WDI data. This could be done manually by downloading the file and unzipping it, but these steps can also be automated with R functions. Note that there is a <a href="https://cran.r-project.org/package=WDI">WDI</a> R package, which provides a way to query the WDI database from within R, and may be better for your purposes. I won’t use it here because dealing with CSV issues is the main purpose of this exercise.</p>
<p>Create a data directory if it does not already exist, and download the zip file if it does not already exists.</p>
<p>I’m going to define multiple variables for URL that I am downloading, and locations of files and directories where I will put stuff. It’s useful to save these as variables (and often to put them at the top of the script) for two reasons.</p>
<p>First, it is easier to have any “dependencies” of the script listed near the beginning - e.g. <code>library</code> statements loading packges, sourcing other R scripts with the <code>source</code> function, and at least the names of external files that you are loading. These are things that could or should go in the documentation or comments, but by putting them near the top and giving them understandable names, the code becomes “self-documenting”.</p>
<p>Second, I can resuse the variables later. I define the <code>dst_dir</code> variable and then define <code>dst_file</code> and <code>wdi_dir</code> using it rather than <code>dst_file &lt;- &quot;data/WDI_csv.zip&quot;</code> and <code>wdi_dir &lt;- &quot;data/WDI&quot;</code>. That way if I want to put everything in <code>output</code>, I don’t need to remember to change the other variables. Another good practice is, if possible, to put any “constant” values near the top of a script. These are inputs manually entered by the user (rather than generated by the logic of the code later), and having them near the top reminds you what things you have defined.</p>
<pre class="r"><code># URL of the zip file
wdi_url &lt;- &quot;http://databank.worldbank.org/data/download/WDI_csv.zip&quot;
# location to save data
dst_dir &lt;- &quot;data&quot;
# since the output directory may not exist, I should create it.
# its subdirectories may also not exist yet, so recursive = TRUE
# but it may already exists, so set showWarnings to be silent
dir.create(dst_dir, showWarnings = FALSE, recursive = TRUE)
dst_file &lt;- file.path(dst_dir, &quot;WDI_csv.zip&quot;)
# directory to unzip the contents of WDI_csv into
wdi_dir &lt;- file.path(dst_dir, &quot;WDI&quot;)</code></pre>
<p>Now download the zip file, and unzip it into <code>data/WDI</code>.</p>
<p><strong>WARNING: this will take a few minutes since it is a large file</strong> But because it takes so long, only download it once. Unzip it to <code>data/WDI</code> using the function <code>unzip()</code>.</p>
<pre class="r"><code>if (!file.exists(dst_file)) {
  download.file(wdi_url, dst_file)
  unzip(dst_file, exdir = wdi_dir)
}</code></pre>
<div id="importing-and-tidying-data" class="section level2">
<h2>Importing and tidying data</h2>
<ol style="list-style-type: decimal">
<li>What files are included in the zip file and what do they seem to correspond to.</li>
</ol>
<p>The original page is <a href="here">http://data.worldbank.org/data-catalog/world-development-indicators</a>, but it doesn not include any data.</p>
<p>Let’s see what files were included in the zip file</p>
<pre class="r"><code>dir(dst_dir)</code></pre>
<pre><code>## [1] &quot;WDI&quot;         &quot;WDI_csv.zip&quot;</code></pre>
<p>The <code>dir</code> function lists the files in a directory. Unfortunately they are all CSV files, and there is no included documentation. However, they are clearly and consistently named.</p>
<p>Since I’m lazy, I don’t want to keep referring to the files as</p>
<pre class="r"><code>file.path(wdi_dir, &quot;WDI_Country.csv&quot;</code></pre>
<p>So I’m going to write a quick function so that I get the path the file by only giving its name. I’m abstracting away how and where these files are stored.</p>
<pre class="r"><code>wdi &lt;- function(name) {
  file.path(wdi_dir, str_c(&quot;WDI_&quot;, name, &quot;.csv&quot;))
}</code></pre>
<p>The <code>file.path</code> function creates a path from the given components,</p>
<pre class="r"><code>file.path(&quot;/path&quot;, &quot;to&quot;, &quot;file&quot;)</code></pre>
<pre><code>## [1] &quot;/path/to/file&quot;</code></pre>
<p>It is similar, but more robust than,</p>
<pre class="r"><code>str_c(&quot;/path&quot;, &quot;to&quot;, &quot;file&quot;, sep = &quot;/&quot;)</code></pre>
<pre><code>## [1] &quot;/path/to/file&quot;</code></pre>
<p>It is also better to <code>file.path</code> because the function name conveys the intent of the operation (you are creating a file name), in a way that <code>str_c</code> does not (you concatenating some character vectors, but it could be for anything). It also uses the correct seperator for different operatings systems.</p>
<p>Since there is no documentation, I open up the files and figure it out.</p>
<p><code>WDI_Country.csv</code> has country-level variables. The table key is <code>Country Code</code>, and it includes names, other country codes, and various information specific to the country.</p>
<pre class="r"><code>wdi_country &lt;- read_csv(wdi(&quot;Country&quot;))
glimpse(wdi_country)</code></pre>
<pre><code>## Observations: 263
## Variables: 31
## $ Country Code                                      &lt;chr&gt; &quot;ABW&quot;, &quot;ADO&quot;...
## $ Short Name                                        &lt;chr&gt; &quot;Aruba&quot;, &quot;An...
## $ Table Name                                        &lt;chr&gt; &quot;Aruba&quot;, &quot;An...
## $ Long Name                                         &lt;chr&gt; &quot;Aruba&quot;, &quot;Pr...
## $ 2-alpha code                                      &lt;chr&gt; &quot;AW&quot;, &quot;AD&quot;, ...
## $ Currency Unit                                     &lt;chr&gt; &quot;Aruban flor...
## $ Special Notes                                     &lt;chr&gt; &quot;SNA data fo...
## $ Region                                            &lt;chr&gt; &quot;Latin Ameri...
## $ Income Group                                      &lt;chr&gt; &quot;High income...
## $ WB-2 code                                         &lt;chr&gt; &quot;AW&quot;, &quot;AD&quot;, ...
## $ National accounts base year                       &lt;chr&gt; &quot;2000&quot;, &quot;200...
## $ National accounts reference year                  &lt;chr&gt; NA, NA, NA, ...
## $ SNA price valuation                               &lt;chr&gt; &quot;Value added...
## $ Lending category                                  &lt;chr&gt; NA, NA, &quot;IDA...
## $ Other groups                                      &lt;chr&gt; NA, NA, &quot;HIP...
## $ System of National Accounts                       &lt;chr&gt; &quot;Country use...
## $ Alternative conversion factor                     &lt;chr&gt; NA, NA, NA, ...
## $ PPP survey year                                   &lt;chr&gt; &quot;2011&quot;, NA, ...
## $ Balance of Payments Manual in use                 &lt;chr&gt; &quot;IMF Balance...
## $ External debt Reporting status                    &lt;chr&gt; NA, NA, &quot;Act...
## $ System of trade                                   &lt;chr&gt; &quot;General tra...
## $ Government Accounting concept                     &lt;chr&gt; NA, NA, &quot;Con...
## $ IMF data dissemination standard                   &lt;chr&gt; NA, NA, &quot;Gen...
## $ Latest population census                          &lt;chr&gt; &quot;2010&quot;, &quot;201...
## $ Latest household survey                           &lt;chr&gt; NA, NA, &quot;Dem...
## $ Source of most recent Income and expenditure data &lt;chr&gt; NA, NA, &quot;Int...
## $ Vital registration complete                       &lt;chr&gt; &quot;Yes&quot;, &quot;Yes&quot;...
## $ Latest agricultural census                        &lt;chr&gt; NA, NA, NA, ...
## $ Latest industrial data                            &lt;int&gt; NA, NA, NA, ...
## $ Latest trade data                                 &lt;int&gt; 2014, 2014, ...
## $ Latest water withdrawal data                      &lt;int&gt; NA, NA, 2000...</code></pre>
<pre class="r"><code>head(wdi_country)</code></pre>
<pre><code>## # A tibble: 6 × 31
##   `Country Code` `Short Name` `Table Name`                  `Long Name`
##            &lt;chr&gt;        &lt;chr&gt;        &lt;chr&gt;                        &lt;chr&gt;
## 1            ABW        Aruba        Aruba                        Aruba
## 2            ADO      Andorra      Andorra      Principality of Andorra
## 3            AFG  Afghanistan  Afghanistan Islamic State of Afghanistan
## 4            AGO       Angola       Angola  People&#39;s Republic of Angola
## 5            ALB      Albania      Albania          Republic of Albania
## 6            ARB   Arab World   Arab World                   Arab World
## # ... with 27 more variables: `2-alpha code` &lt;chr&gt;, `Currency Unit` &lt;chr&gt;,
## #   `Special Notes` &lt;chr&gt;, Region &lt;chr&gt;, `Income Group` &lt;chr&gt;, `WB-2
## #   code` &lt;chr&gt;, `National accounts base year` &lt;chr&gt;, `National accounts
## #   reference year` &lt;chr&gt;, `SNA price valuation` &lt;chr&gt;, `Lending
## #   category` &lt;chr&gt;, `Other groups` &lt;chr&gt;, `System of National
## #   Accounts` &lt;chr&gt;, `Alternative conversion factor` &lt;chr&gt;, `PPP survey
## #   year` &lt;chr&gt;, `Balance of Payments Manual in use` &lt;chr&gt;, `External debt
## #   Reporting status` &lt;chr&gt;, `System of trade` &lt;chr&gt;, `Government
## #   Accounting concept` &lt;chr&gt;, `IMF data dissemination standard` &lt;chr&gt;,
## #   `Latest population census` &lt;chr&gt;, `Latest household survey` &lt;chr&gt;,
## #   `Source of most recent Income and expenditure data` &lt;chr&gt;, `Vital
## #   registration complete` &lt;chr&gt;, `Latest agricultural census` &lt;chr&gt;,
## #   `Latest industrial data` &lt;int&gt;, `Latest trade data` &lt;int&gt;, `Latest
## #   water withdrawal data` &lt;int&gt;</code></pre>
<p><code>WDI_Data.csv</code> has the bulk of the WDI data. The table key is the combination of a country ID (<code>Country Code</code>) and the <code>Indicator Code</code>, with the columns being years of data, and the cells being the values of those indicators.</p>
<pre class="r"><code>wdi_data &lt;- read_csv(wdi(&quot;Data&quot;), progress = FALSE)
glimpse(wdi_data)</code></pre>
<pre><code>## Observations: 383,328
## Variables: 61
## $ Country Name   &lt;chr&gt; &quot;Arab World&quot;, &quot;Arab World&quot;, &quot;Arab World&quot;, &quot;Arab...
## $ Country Code   &lt;chr&gt; &quot;ARB&quot;, &quot;ARB&quot;, &quot;ARB&quot;, &quot;ARB&quot;, &quot;ARB&quot;, &quot;ARB&quot;, &quot;ARB&quot;...
## $ Indicator Name &lt;chr&gt; &quot;2005 PPP conversion factor, GDP (LCU per inter...
## $ Indicator Code &lt;chr&gt; &quot;PA.NUS.PPP.05&quot;, &quot;PA.NUS.PRVT.PP.05&quot;, &quot;EG.ELC.A...
## $ 1960           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ 1961           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ 1962           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ 1963           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ 1964           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ 1965           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ 1966           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ 1967           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ 1968           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ 1969           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ 1970           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ 1971           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ 1972           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ 1973           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ 1974           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ 1975           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ 1976           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ 1977           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ 1978           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ 1979           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ 1980           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ 1981           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ 1982           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ 1983           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ 1984           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ 1985           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ 1986           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ 1987           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ 1988           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ 1989           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ 1990           &lt;dbl&gt; NA, NA, 7.546396e+01, 5.869606e+01, 9.184719e+0...
## $ 1991           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ 1992           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ 1993           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ 1994           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ 1995           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ 1996           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ 1997           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ 1998           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ 1999           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ 2000           &lt;dbl&gt; NA, NA, 7.953486e+01, 6.586757e+01, 9.165335e+0...
## $ 2001           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ 2002           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ 2003           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ 2004           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ 2005           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ 2006           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ 2007           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ 2008           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ 2009           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ 2010           &lt;dbl&gt; NA, NA, 8.436235e+01, 7.198423e+01, 9.383966e+0...
## $ 2011           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ 2012           &lt;dbl&gt; NA, NA, 8.628035e+01, 7.391781e+01, 9.515673e+0...
## $ 2013           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ 2014           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ 2015           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...
## $ 2016           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,...</code></pre>
<pre class="r"><code>wdi_data %&gt;% select(1:5) %&gt;% slice(1:2)</code></pre>
<pre><code>## # A tibble: 2 × 5
##   `Country Name` `Country Code`
##            &lt;chr&gt;          &lt;chr&gt;
## 1     Arab World            ARB
## 2     Arab World            ARB
## # ... with 3 more variables: `Indicator Name` &lt;chr&gt;, `Indicator
## #   Code` &lt;chr&gt;, `1960` &lt;dbl&gt;</code></pre>
<p>Many of these columns have “non-syntactic” names, i.e. we couldn’t use them as a variable in R. To reference them surround them in backticks.</p>
<pre class="r"><code>select(wdi_data, `Country Code`, `Indicator Code`) %&gt;% head()</code></pre>
<pre><code>## # A tibble: 6 × 2
##   `Country Code`  `Indicator Code`
##            &lt;chr&gt;             &lt;chr&gt;
## 1            ARB     PA.NUS.PPP.05
## 2            ARB PA.NUS.PRVT.PP.05
## 3            ARB    EG.ELC.ACCS.ZS
## 4            ARB EG.ELC.ACCS.RU.ZS
## 5            ARB EG.ELC.ACCS.UR.ZS
## 6            ARB    EG.NSF.ACCS.ZS</code></pre>
<pre class="r"><code>wdi_data$`Country Code`[1:2]</code></pre>
<pre><code>## [1] &quot;ARB&quot; &quot;ARB&quot;</code></pre>
<p>However, if you are using <code>[[</code> (and providing a character vector of variable names) you don’t need backticks,</p>
<pre class="r"><code>wdi_data[[&quot;Country Code&quot;]][1:2]</code></pre>
<pre><code>## [1] &quot;ARB&quot; &quot;ARB&quot;</code></pre>
<p><code>WDI_Description.csv</code> is unusual.</p>
<pre class="r"><code>read_csv(wdi(&quot;Description&quot;))</code></pre>
<pre><code>## # A tibble: 88 × 1
##                                                 `World Development Indicators`
##                                                                          &lt;chr&gt;
## 1                                                               The World Bank
## 2                                                              3 January, 2017
## 3  World Development Indicators (WDI) is the primary World Bank database for d
## 4  See other worksheets in this Excel file for a list of series changes since 
## 5  3 January, 2017: A minor update was processed to correct additional governm
## 6  28 December, 2016: A minor update was processed to revise historical data f
## 7  21 December, 2016: A minor update was processed to correct government finan
## 8  16 December, 2016: This release features new external debt data from the In
## 9  17 November, 2016: Data have been updated for Doing Business indicators, an
## 10 14 October, 2016: An update was processed for national poverty and child mo
## # ... with 78 more rows</code></pre>
<p>It has the extension <code>.csv</code> but this looks like a text file (trust but verify file-extensions, they can lie to you); it only has one column, with a bad name. It has a header with the date of the last data revision, and comments on dates of data revisions.</p>
<p><code>WDI_CS_Notes.csv</code> seems to be <code>C</code>ountry-<code>S</code>eries data with notes for different series for each country. For example the sources used for each country. The keys are <code>CountryCode</code> and <code>SeriesCode</code>.</p>
<pre class="r"><code>wdi_cs_notes &lt;- read_csv(wdi(&quot;CS_Notes&quot;))
wdi_cs_notes %&gt;% select(DESCRIPTION) %&gt;% slice(1:3) </code></pre>
<pre><code>## # A tibble: 3 × 1
##                                                                   DESCRIPTION
##                                                                         &lt;chr&gt;
## 1 Sources: Estimated based on UN Energy Statistics (2014); World Development 
## 2                                        Sources: UN Energy Statistics (2014)
## 3                                        Sources: UN Energy Statistics (2014)</code></pre>
<p><code>WDI_Footnotes.csv</code> has notes for each <em>cell</em> in <code>WDI_Data.csv</code> (the combination of country, series, and year). The keys are <code>CountryCode</code>, <code>SeriesCode</code>, and <code>Year</code>. There’s a few weird things here: <code>Year</code> values are prefixed by <code>YR</code></p>
<pre class="r"><code>wdi_footnotes &lt;- read_csv(wdi(&quot;Footnotes&quot;))
glimpse(wdi_footnotes)</code></pre>
<pre><code>## Observations: 584,006
## Variables: 4
## $ CountryCode &lt;chr&gt; &quot;ABW&quot;, &quot;ABW&quot;, &quot;ABW&quot;, &quot;ABW&quot;, &quot;ABW&quot;, &quot;ABW&quot;, &quot;ABW&quot;, &quot;...
## $ SeriesCode  &lt;chr&gt; &quot;AG.LND.FRST.K2&quot;, &quot;AG.LND.FRST.K2&quot;, &quot;AG.LND.FRST.K...
## $ Year        &lt;chr&gt; &quot;YR1990&quot;, &quot;YR2000&quot;, &quot;YR2005&quot;, &quot;YR1988&quot;, &quot;YR1989&quot;, ...
## $ DESCRIPTION &lt;chr&gt; &quot;Not specified&quot;, &quot;Not specified&quot;, &quot;Not specified&quot;,...</code></pre>
<pre class="r"><code>wdi_footnotes$DESCRIPTION[1:3]</code></pre>
<pre><code>## [1] &quot;Not specified&quot; &quot;Not specified&quot; &quot;Not specified&quot;</code></pre>
<p><code>WDI_Series.csv</code> has metadata on the <code>Series</code>. Notably, it has human readable descriptions of the unique series identifiers.</p>
<pre class="r"><code>wdi_series &lt;- read_csv(wdi(&quot;Series&quot;))
glimpse(wdi_series)</code></pre>
<pre><code>## Observations: 1,452
## Variables: 20</code></pre>
<pre><code>## Error in nchar(x): invalid multibyte string, element 11</code></pre>
<p>Damn, that sucks. The error message <code>invalid multibyte string</code> effectively means there was a character in this file that was not recognized by the character encoding setting we are using. The part <code>element 11</code> means it was character 11. It could also be character 10, since off the top of head I’m not sure whether this is counting from 0 or 1 (see <a href="https://en.wikipedia.org/wiki/Zero-based_numbering">zero-based numbering</a>).</p>
<p>Stop. Right now. Watch this video.</p>
<div class="figure">
<img src="https://www.youtube.com/watch?v=MijmeoH9LT4" />

</div>
<p>Okay, now you’re back and you have some idea of what a character encoding is: it is a mapping from a number to the character (glyph) to display. There are lots of them. The world has more or less settled on one called <a href="https://en.wikipedia.org/wiki/UTF-8">UTF-8</a>, but there are still many files of different encodings floating around. This appears to be one of them. By default, <code>read_csv</code> reads the data using UTF-8, and the <code>locale</code> argument controls several settings, including the encoding to use. So, to load this data, I need to figure out two things (1) what encoding the data is in, and (2) how to use <code>locale()</code></p>
<p>There is no perfect way to tell the character encoding of a file. When reading a file, a program can tell its <em>not</em> a certain encoding if it encounters a byte pattern that isn’t used by that encoding. But there’s no sure way to tell if it is a certain encoding. The way this is “solved” is using an algorithm that guesses the encoding using some hueristics. The <strong>readr</strong> package includes the function <code>guess_encoding</code>:</p>
<pre class="r"><code>guess_encoding(wdi(&quot;Series&quot;))</code></pre>
<pre><code>##     encoding confidence
## 1 ISO-8859-1       0.72
## 2 ISO-8859-2       0.22</code></pre>
<p>It guesses it is either <a href="https://en.wikipedia.org/wiki/ISO/IEC_8859-1">ISO-8859-1</a> (Latin1) or <a href="https://en.wikipedia.org/wiki/ISO/IEC_8859-2">ISO-8859-2</a> (Latin2) After reading the Wikipodia pages on them, we know these are encodings that also include the accented Latin letters and other letters used in European languages that use the Latin alphabet.</p>
<p>See the R4DS section <a href="http://r4ds.had.co.nz/data-import.html#readr-strings">11.3.2 Parsing a vector: Strings</a> for how to use locale. I’ll define a new locale using the “Latin1” encoding (equivalent to ISO-8859-1, but more descriptive),</p>
<pre class="r"><code>locale_latin1 &lt;- locale(encoding = &quot;Latin1&quot;)
wdi_series &lt;- read_csv(wdi(&quot;Series&quot;), locale = locale_latin1)</code></pre>
<p>Now it works!</p>
<pre class="r"><code>glimpse(wdi_series)</code></pre>
<pre><code>## Observations: 1,452
## Variables: 20
## $ Series Code                         &lt;chr&gt; &quot;AG.AGR.TRAC.NO&quot;, &quot;AG.CON....
## $ Topic                               &lt;chr&gt; &quot;Environment: Agricultural...
## $ Indicator Name                      &lt;chr&gt; &quot;Agricultural machinery, t...
## $ Short definition                    &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA...
## $ Long definition                     &lt;chr&gt; &quot;Agricultural machinery re...
## $ Unit of measure                     &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA...
## $ Periodicity                         &lt;chr&gt; &quot;Annual&quot;, &quot;Annual&quot;, &quot;Annua...
## $ Base Period                         &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA...
## $ Other notes                         &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA...
## $ Aggregation method                  &lt;chr&gt; &quot;Sum&quot;, &quot;Weighted average&quot;,...
## $ Limitations and exceptions          &lt;chr&gt; &quot;The data are collected by...
## $ Notes from original source          &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA...
## $ General comments                    &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA...
## $ Source                              &lt;chr&gt; &quot;Food and Agriculture Orga...
## $ Statistical concept and methodology &lt;chr&gt; &quot;A tractor provides the po...
## $ Development relevance               &lt;chr&gt; &quot;Agricultural land covers ...
## $ Related source links                &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA...
## $ Other web links                     &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA...
## $ Related indicators                  &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA...
## $ License Type                        &lt;chr&gt; &quot;Open&quot;, &quot;Open&quot;, &quot;Open&quot;, &quot;O...</code></pre>
<p>The key for this table is <code>Series Code</code>, and it has a variety of metadata on the series. <code>Indicator name</code> is a human friendly label for the variable.</p>
<ol start="2" style="list-style-type: decimal">
<li>Load the country-level CSV file. Print out the full names of the countries. What’s wrong with them Use the <code>readr::guess_encoding</code> function to find the probable encoding, adjust the <code>locale</code> to be able to load the data in the correct format.</li>
</ol>
<pre class="r"><code>wdi_country$`Long Name`</code></pre>
<p>If you scan through the output you’ll notice some names that have errors. Here are a few country names with problems.</p>
<pre class="r"><code>wdi_country$`Long Name`[c(40, 49, 216)]</code></pre>
<pre><code>## [1] &quot;Republic of C\xf4te d&#39;Ivoire&quot;                   
## [2] &quot;Cura\xe7ao&quot;                                        
## [3] &quot;Democratic Republic of S\xe3o Tom\xe9 and Principe&quot;</code></pre>
<p>They should read “Republic of Côte d’Ivoire”, “Curaçao”, and “Democratic Republicn of São Tomé and Principé”), but instead they have symbols like <code>\xf4</code>. A leading <code>\x</code> usually refers to a <a href="https://en.wikipedia.org/wiki/Hexadecimal">hexadecimal number</a>. In this case it is the hexadecimal number of the character which the encoding can’t recognize. Often, googling for these hexadecimal numbers will let you figure out what it should be, and perhaps the encoding (you probably aren’t the first person to encounter that problem). Other ways in which encoding problems are indicated (not in R) could be with a leading <code>\u</code> for a unicode character, or the use of the symbol � or the empty box (for missing emoji).</p>
<p>To figure out what the encoding is, I’ll again use <code>guess_encoding</code>:</p>
<pre class="r"><code>guess_encoding(wdi(&quot;Country&quot;))</code></pre>
<pre><code>##       encoding confidence
## 1 windows-1252       0.56
## 2 windows-1250       0.22</code></pre>
<p>This file is guessed to be <a href="https://en.wikipedia.org/wiki/Windows-1252">Windows-1252</a> (sometimes called CP-1252 where CP stands for “code point”). But that is different than the previous file, which was encoded as ISO-1859-1.</p>
<p>WTF? Are the files encoded differently? Now I’m paranoid. I should check all the CSV files to see their encodings.</p>
<pre class="r"><code>for (filename in dir(wdi_dir, full.names = TRUE)) {
  cat(filename, &quot;\n&quot;)
  print(guess_encoding(filename))
}</code></pre>
<pre><code>## data/WDI/WDI_Country.csv 
##       encoding confidence
## 1 windows-1252       0.56
## 2 windows-1250       0.22
## data/WDI/WDI_CS_Notes.csv 
##       encoding confidence
## 1 windows-1252       0.50
## 2 windows-1250       0.22
## data/WDI/WDI_Data.csv 
##   encoding confidence
## 1    ASCII          1
## data/WDI/WDI_Description.csv 
##     encoding confidence
## 1 ISO-8859-1       0.71
## 2 ISO-8859-2       0.23
## data/WDI/WDI_Footnotes.csv 
##     encoding confidence
## 1 ISO-8859-1       0.46
## data/WDI/WDI_Series.csv 
##     encoding confidence
## 1 ISO-8859-1       0.72
## 2 ISO-8859-2       0.22
## data/WDI/WDI_ST_Notes.csv 
##     encoding confidence
## 1 ISO-8859-1       0.75</code></pre>
<p>Bug after reading through the Wikpedia page and some additional Googling, I learn that Windows-1252 is a <em>superset</em> of ISO-1859-1. This means that we lose nothing by specifying Windows-1252, and a few files must use one of the characters that appears in Windows-1252 and not ISO-1859-1. So I can set the encoding to <code>Windows-1252</code> for all the CSV files.</p>
<p>This may seem terribly complicated, and I don’t envy the engineers who have had to figure out and maintain all this. But, what you just learned will cover 99% of all your encoding issues as long as you are working with English or Western European language texts.</p>
<p>Try UTF-8. If there are problems with loading it using the default UTF-8, it was probably created by some Windows program that used Windows-1252. Try that. If Windows-1252 doesn’t work, then you have a problem. However, you are working with Chinese, Japanese, Arabic, Cyrillic, … that’s another story).</p>
<p>As before, I’ll create a new <code>locale</code> object with Windows-1252 encoding.</p>
<pre class="r"><code>locale_windows1252 &lt;- locale(encoding = &quot;Windows-1252&quot;)</code></pre>
<p>I’ll need to reload all the files using that new encoding. I could load each file separately,</p>
<pre class="r"><code>wdi_country &lt;- read_csv(wdi(&quot;Country&quot;), locale = locale_windows1252)
wdi_data &lt;- read_csv(wdi(&quot;CS_Notes&quot;), locale = locale_windows1252)
# ... and so on</code></pre>
<p>But this is seeming redundant, I am continually calling <code>read_csv(wdi(name), locale = locale_windows1252)</code>. As R4DS says, if you copy something three or more times, you should write a function. So here it is,</p>
<pre class="r"><code>read_wdi_csv &lt;- function(file, ...) {
  read_csv(file, ..., locale = locale(encoding = &quot;Windows-1252&quot;))
}</code></pre>
<p>The <code>...</code> passes arguments to <code>read_csv</code>, which is useful if it turns out that a specific file needs to be treated differently. Now I can do this:</p>
<pre class="r"><code>wdi_country &lt;- read_wdi_csv(wdi(&quot;Country&quot;))
wdi_cs_notes &lt;- read_wdi_csv(wdi(&quot;CS_Notes&quot;))
wdi_data &lt;- read_wdi_csv(wdi(&quot;Data&quot;), progress = FALSE)
wdi_description &lt;- read_wdi_csv(wdi(&quot;Description&quot;))
wdi_footnotes &lt;- read_wdi_csv(wdi(&quot;Footnotes&quot;))
wdi_series &lt;- read_wdi_csv(wdi(&quot;Series&quot;))
wdi_st_notes &lt;- read_wdi_csv(wdi(&quot;ST_Notes&quot;))</code></pre>
<p>But even that seems annoying and redundant. I already have a list of filenames, and I want to name them similarly to their filenames. I will load them using the same function, so I really should be using a loop, which would look something like this.</p>
<pre><code>for (filename in filelist) {
   nameofvar &lt;- read_csv(filename, locale = locale_windows1252
}</code></pre>
<p>I can get the names of the files using <code>dir</code>. But how do I programmatically generate the variable names. The answer is to put them in a list, and then refer to the list.</p>
<pre class="r"><code># create
filenames &lt;- dir(wdi_dir, full.names = TRUE)
WDI &lt;- vector(&quot;list&quot;, length(filenames))
wdi_names &lt;- vector(&quot;character&quot;, length(filenames))
# for filename in filenames is too confusing
for (i in seq_along(filenames)) {
  fn &lt;- filenames[i]
  # get only the file-part of the file
  name &lt;- basename(fn)
  # extract the name part
  name &lt;- str_match(name, &quot;WDI_(.*)\\.csv&quot;)[1, 2]
  # I want the names to be lower-cased
  name &lt;- str_to_lower(name)
  WDI[[i]] &lt;- read_wdi_csv(fn, progress = FALSE)
  wdi_names[[i]] &lt;- name
}
names(WDI) &lt;- wdi_names</code></pre>
<p><em>Note</em> I had to adjust this code several times to get the looping and naming correct.</p>
<p>To see what was going on inside the loop to generate the names of the lis elements:</p>
<pre class="r"><code>fn &lt;- &quot;data/WDI/WDI_Country.csv&quot;
name &lt;- basename(fn)
print(name)</code></pre>
<pre><code>## [1] &quot;WDI_Country.csv&quot;</code></pre>
<pre class="r"><code>str_match(name, &quot;WDI_(.*)\\.csv&quot;)</code></pre>
<pre><code>##      [,1]              [,2]     
## [1,] &quot;WDI_Country.csv&quot; &quot;Country&quot;</code></pre>
<pre class="r"><code>name &lt;- str_match(name, &quot;WDI_(.*)\\.csv&quot;)[1, 2]
name</code></pre>
<pre><code>## [1] &quot;Country&quot;</code></pre>
<pre class="r"><code>str_to_lower(name)</code></pre>
<pre><code>## [1] &quot;country&quot;</code></pre>
<p>Now I have a list of tibbles, with names based off their CSV filenames.</p>
<pre class="r"><code>names(WDI)</code></pre>
<pre><code>## [1] &quot;country&quot;     &quot;cs_notes&quot;    &quot;data&quot;        &quot;description&quot; &quot;footnotes&quot;  
## [6] &quot;series&quot;      &quot;st_notes&quot;</code></pre>
<pre class="r"><code>glimpse(WDI[[&quot;country&quot;]])</code></pre>
<pre><code>## Observations: 263
## Variables: 31
## $ Country Code                                      &lt;chr&gt; &quot;ABW&quot;, &quot;ADO&quot;...
## $ Short Name                                        &lt;chr&gt; &quot;Aruba&quot;, &quot;An...
## $ Table Name                                        &lt;chr&gt; &quot;Aruba&quot;, &quot;An...
## $ Long Name                                         &lt;chr&gt; &quot;Aruba&quot;, &quot;Pr...
## $ 2-alpha code                                      &lt;chr&gt; &quot;AW&quot;, &quot;AD&quot;, ...
## $ Currency Unit                                     &lt;chr&gt; &quot;Aruban flor...
## $ Special Notes                                     &lt;chr&gt; &quot;SNA data fo...
## $ Region                                            &lt;chr&gt; &quot;Latin Ameri...
## $ Income Group                                      &lt;chr&gt; &quot;High income...
## $ WB-2 code                                         &lt;chr&gt; &quot;AW&quot;, &quot;AD&quot;, ...
## $ National accounts base year                       &lt;chr&gt; &quot;2000&quot;, &quot;200...
## $ National accounts reference year                  &lt;chr&gt; NA, NA, NA, ...
## $ SNA price valuation                               &lt;chr&gt; &quot;Value added...
## $ Lending category                                  &lt;chr&gt; NA, NA, &quot;IDA...
## $ Other groups                                      &lt;chr&gt; NA, NA, &quot;HIP...
## $ System of National Accounts                       &lt;chr&gt; &quot;Country use...
## $ Alternative conversion factor                     &lt;chr&gt; NA, NA, NA, ...
## $ PPP survey year                                   &lt;chr&gt; &quot;2011&quot;, NA, ...
## $ Balance of Payments Manual in use                 &lt;chr&gt; &quot;IMF Balance...
## $ External debt Reporting status                    &lt;chr&gt; NA, NA, &quot;Act...
## $ System of trade                                   &lt;chr&gt; &quot;General tra...
## $ Government Accounting concept                     &lt;chr&gt; NA, NA, &quot;Con...
## $ IMF data dissemination standard                   &lt;chr&gt; NA, NA, &quot;Gen...
## $ Latest population census                          &lt;chr&gt; &quot;2010&quot;, &quot;201...
## $ Latest household survey                           &lt;chr&gt; NA, NA, &quot;Dem...
## $ Source of most recent Income and expenditure data &lt;chr&gt; NA, NA, &quot;Int...
## $ Vital registration complete                       &lt;chr&gt; &quot;Yes&quot;, &quot;Yes&quot;...
## $ Latest agricultural census                        &lt;chr&gt; NA, NA, NA, ...
## $ Latest industrial data                            &lt;int&gt; NA, NA, NA, ...
## $ Latest trade data                                 &lt;int&gt; 2014, 2014, ...
## $ Latest water withdrawal data                      &lt;int&gt; NA, NA, 2000...</code></pre>
<p>This may have been overkill for this particular case. It is also the result of me cleaning data for many years so I’ve developed certain generalizable patterns. But where you can, start to use parts of the pipeline above, such as writing functions for reusable parts of the data-processing pipeline, Loading files in a loop or iteratively rather than copying and pasting.</p>
<ol start="4" style="list-style-type: decimal">
<li><p>Is this tidy data? Why or why not? Why do you think they organized the data this way?</p></li>
<li><p>Create a tidy dataset in which the rows correspond to (country, year) tuples, and <code>country</code>, <code>year</code>, and all the indicators are columns.</p></li>
</ol>
<p>It’s not tidy. If the rows should be (country-year) observations, and the columns the series.</p>
<p>This creates a data-frame with four columns: country, series, year, and the value.</p>
<pre class="r"><code>wdi_data_cst &lt;-
  WDI$data %&gt;%
  select(-`Indicator Name`, `Country Name`) %&gt;%
  gather(year, value, matches(&quot;^[0-9][0-9][0-9][0-9]$&quot;),
         na.rm = TRUE)</code></pre>
<p>We’ll see later that this format can be useful for (1) simultaneously summarizing many varaibles, or (2) plotting multiple variables in ggplot.</p>
<p>When selecting the columns to gather I used the <code>matches</code> function which selects columns by a regular expression pattern (See the R4DS chapter <a href="http://r4ds.had.co.nz/strings.html">Strings</a>). In this case, I wanted to select columns which had names consisting of four-numbers.</p>
<p>There are a few other options I could have used for the <code>gather</code> expression. This selects everything but the country and indicator variables.</p>
<pre class="r"><code>gather(year, value, -`Country Name`, -`Indicator Code`)</code></pre>
<p>But what if I didn’t drop <code>Indicator Name</code>, and <code>Country Name</code>? The code would break.</p>
<p>You may be wondering why I dropped <code>Indicator Name</code> and <code>Country Name</code>. I dropped <code>Indicator Name</code> because it would not work when I would need to spread the data to make the series into separate columns. I dropped <code>Country Name</code> since later, I will merge the country data from <code>WDI_Country.csv</code>, and that has multiple country name variables.</p>
<p>So I could have manually entered the years, and done so using a range:</p>
<pre class="r"><code>gather(year, value, `1960`:`2016`) </code></pre>
<p>However, this requires that I know the range of years, and it could break if I ran the code again next year, when there will be a column for 2017.</p>
<p>But why did the World Bank set up the data like this? Recall the other files that are provided. Some of them have metadata on series, country-series, and countries. With the data in the original format we can merge series metadata from <code>WDI_Series</code> with <code>WDI_Data</code>:</p>
<pre class="r"><code>left_join(WDI$data, WDI$series,
          by = c(&quot;Indicator Code&quot; = &quot;Series Code&quot;))</code></pre>
<p>We couldn’t do that if the years were in rows, and the series were seperate columns. So for some manipulations, the original format is better, and for others the tidy format will be better. What is not cool is naming the column “Indicator Code” in one data set and “Series Code” in the other.</p>
<p>I specified the option <code>na.rm = TRUE</code> to <code>gather()</code> in order to drop missing values since this is a larger dataset.</p>
<p>To make the tidy dataset, call <code>spread</code> in order to make a column for each value in <code>Indicator Code</code>, filled in with the numbers in the <code>value</code> column.</p>
<pre class="r"><code>wdi_data_tidy &lt;- wdi_data_cst %&gt;%
  spread(`Indicator Code`, value)
dim(wdi_data_tidy)</code></pre>
<pre><code>## [1] 14990  1453</code></pre>
<ol start="5" style="list-style-type: decimal">
<li>Merge the tidy data with the country-level data.</li>
</ol>
<pre class="r"><code>wdi_data_tidy &lt;- 
  left_join(wdi_data_tidy, WDI$country, by = &quot;Country Code&quot;)</code></pre>
<p>Sometimes you have to worry about whether the indicators are the same or if everything</p>
<pre class="r"><code>wdi_data_tidy %&gt;%
  count(`Country Code`) %&gt;%
  anti_join(WDI$country, by = &quot;Country Code&quot;)</code></pre>
<pre><code>## # A tibble: 0 × 2
## # ... with 2 variables: Country Code &lt;chr&gt;, n &lt;int&gt;</code></pre>
<p>By the way, although <code>left_join</code> will merge two data frames using any variables that appear in both, you should <em>always</em> explicitly specify an argument in <code>by</code>. There are at least two reasons to do this: (1) it makes the code self-documenting. Which gives you a better idea of what the code is doing?</p>
<pre class="r"><code>left_join(wdi_data_tidy, WDI$country)</code></pre>
<p>or</p>
<pre class="r"><code>left_join(wdi_data_tidy, WDI$country, by = &quot;Country Code&quot;)</code></pre>
<p>In the former, I’d probably include a comment as to what I was merging on:</p>
<pre class="r"><code># merge the tidy data to country level data by country codes
left_join(wdi_data_tidy, WDI$country)</code></pre>
<pre><code>## Joining, by = c(&quot;Country Code&quot;, &quot;Short Name&quot;, &quot;Table Name&quot;, &quot;Long Name&quot;, &quot;2-alpha code&quot;, &quot;Currency Unit&quot;, &quot;Special Notes&quot;, &quot;Region&quot;, &quot;Income Group&quot;, &quot;WB-2 code&quot;,   ...</code></pre>
<pre><code>## # A tibble: 14,990 × 1,483
##    `Country Name` `Country Code`  year AG.AGR.TRAC.NO AG.CON.FERT.PT.ZS
##             &lt;chr&gt;          &lt;chr&gt; &lt;chr&gt;          &lt;dbl&gt;             &lt;dbl&gt;
## 1     Afghanistan            AFG  1960             NA                NA
## 2     Afghanistan            AFG  1961            120                NA
## 3     Afghanistan            AFG  1962            150                NA
## 4     Afghanistan            AFG  1963            200                NA
## 5     Afghanistan            AFG  1964            200                NA
## 6     Afghanistan            AFG  1965            300                NA
## 7     Afghanistan            AFG  1966            400                NA
## 8     Afghanistan            AFG  1967            500                NA
## 9     Afghanistan            AFG  1968            500                NA
## 10    Afghanistan            AFG  1969            550                NA
## # ... with 14,980 more rows, and 1478 more variables:
## #   AG.CON.FERT.ZS &lt;dbl&gt;, AG.LND.AGRI.K2 &lt;dbl&gt;, AG.LND.AGRI.ZS &lt;dbl&gt;,
## #   AG.LND.ARBL.HA &lt;dbl&gt;, AG.LND.ARBL.HA.PC &lt;dbl&gt;, AG.LND.ARBL.ZS &lt;dbl&gt;,
## #   AG.LND.CREL.HA &lt;dbl&gt;, AG.LND.CROP.ZS &lt;dbl&gt;, AG.LND.EL5M.RU.K2 &lt;dbl&gt;,
## #   AG.LND.EL5M.RU.ZS &lt;dbl&gt;, AG.LND.EL5M.UR.K2 &lt;dbl&gt;,
## #   AG.LND.EL5M.UR.ZS &lt;dbl&gt;, AG.LND.EL5M.ZS &lt;dbl&gt;, AG.LND.FRST.K2 &lt;dbl&gt;,
## #   AG.LND.FRST.ZS &lt;dbl&gt;, AG.LND.IRIG.AG.ZS &lt;dbl&gt;, AG.LND.PRCP.MM &lt;dbl&gt;,
## #   AG.LND.TOTL.K2 &lt;dbl&gt;, AG.LND.TOTL.RU.K2 &lt;dbl&gt;,
## #   AG.LND.TOTL.UR.K2 &lt;dbl&gt;, AG.LND.TRAC.ZS &lt;dbl&gt;, AG.PRD.CREL.MT &lt;dbl&gt;,
## #   AG.PRD.CROP.XD &lt;dbl&gt;, AG.PRD.FOOD.XD &lt;dbl&gt;, AG.PRD.LVSK.XD &lt;dbl&gt;,
## #   AG.SRF.TOTL.K2 &lt;dbl&gt;, AG.YLD.CREL.KG &lt;dbl&gt;, BG.GSR.NFSV.GD.ZS &lt;dbl&gt;,
## #   BM.GSR.CMCP.ZS &lt;dbl&gt;, BM.GSR.FCTY.CD &lt;dbl&gt;, BM.GSR.GNFS.CD &lt;dbl&gt;,
## #   BM.GSR.INSF.ZS &lt;dbl&gt;, BM.GSR.MRCH.CD &lt;dbl&gt;, BM.GSR.NFSV.CD &lt;dbl&gt;,
## #   BM.GSR.ROYL.CD &lt;dbl&gt;, BM.GSR.TOTL.CD &lt;dbl&gt;, BM.GSR.TRAN.ZS &lt;dbl&gt;,
## #   BM.GSR.TRVL.ZS &lt;dbl&gt;, BM.KLT.DINV.CD.WD &lt;dbl&gt;,
## #   BM.KLT.DINV.WD.GD.ZS &lt;dbl&gt;, BM.TRF.PRVT.CD &lt;dbl&gt;,
## #   BM.TRF.PWKR.CD.DT &lt;dbl&gt;, BN.CAB.XOKA.CD &lt;dbl&gt;,
## #   BN.CAB.XOKA.GD.ZS &lt;dbl&gt;, BN.FIN.TOTL.CD &lt;dbl&gt;, BN.GSR.FCTY.CD &lt;dbl&gt;,
## #   BN.GSR.GNFS.CD &lt;dbl&gt;, BN.GSR.MRCH.CD &lt;dbl&gt;, BN.KAC.EOMS.CD &lt;dbl&gt;,
## #   BN.KLT.DINV.CD &lt;dbl&gt;, BN.KLT.PTXL.CD &lt;dbl&gt;, BN.RES.INCL.CD &lt;dbl&gt;,
## #   BN.TRF.CURR.CD &lt;dbl&gt;, BN.TRF.KOGT.CD &lt;dbl&gt;, BX.GRT.EXTA.CD.WD &lt;dbl&gt;,
## #   BX.GRT.TECH.CD.WD &lt;dbl&gt;, BX.GSR.CCIS.CD &lt;dbl&gt;, BX.GSR.CCIS.ZS &lt;dbl&gt;,
## #   BX.GSR.CMCP.ZS &lt;dbl&gt;, BX.GSR.FCTY.CD &lt;dbl&gt;, BX.GSR.GNFS.CD &lt;dbl&gt;,
## #   BX.GSR.INSF.ZS &lt;dbl&gt;, BX.GSR.MRCH.CD &lt;dbl&gt;, BX.GSR.NFSV.CD &lt;dbl&gt;,
## #   BX.GSR.ROYL.CD &lt;dbl&gt;, BX.GSR.TOTL.CD &lt;dbl&gt;, BX.GSR.TRAN.ZS &lt;dbl&gt;,
## #   BX.GSR.TRVL.ZS &lt;dbl&gt;, BX.KLT.DINV.CD.WD &lt;dbl&gt;,
## #   BX.KLT.DINV.WD.GD.ZS &lt;dbl&gt;, BX.KLT.DREM.CD.DT &lt;dbl&gt;,
## #   BX.PEF.TOTL.CD.WD &lt;dbl&gt;, BX.TRF.CURR.CD &lt;dbl&gt;, BX.TRF.PWKR.CD &lt;dbl&gt;,
## #   BX.TRF.PWKR.CD.DT &lt;dbl&gt;, BX.TRF.PWKR.DT.GD.ZS &lt;dbl&gt;,
## #   CM.MKT.INDX.ZG &lt;dbl&gt;, CM.MKT.LCAP.CD &lt;dbl&gt;, CM.MKT.LCAP.GD.ZS &lt;dbl&gt;,
## #   CM.MKT.LDOM.NO &lt;dbl&gt;, CM.MKT.TRAD.CD &lt;dbl&gt;, CM.MKT.TRAD.GD.ZS &lt;dbl&gt;,
## #   CM.MKT.TRNR &lt;dbl&gt;, DC.DAC.AUSL.CD &lt;dbl&gt;, DC.DAC.AUTL.CD &lt;dbl&gt;,
## #   DC.DAC.BELL.CD &lt;dbl&gt;, DC.DAC.CANL.CD &lt;dbl&gt;, DC.DAC.CECL.CD &lt;dbl&gt;,
## #   DC.DAC.CHEL.CD &lt;dbl&gt;, DC.DAC.CZEL.CD &lt;dbl&gt;, DC.DAC.DEUL.CD &lt;dbl&gt;,
## #   DC.DAC.DNKL.CD &lt;dbl&gt;, DC.DAC.ESPL.CD &lt;dbl&gt;, DC.DAC.FINL.CD &lt;dbl&gt;,
## #   DC.DAC.FRAL.CD &lt;dbl&gt;, DC.DAC.GBRL.CD &lt;dbl&gt;, DC.DAC.GRCL.CD &lt;dbl&gt;,
## #   DC.DAC.IRLL.CD &lt;dbl&gt;, DC.DAC.ISLL.CD &lt;dbl&gt;, DC.DAC.ITAL.CD &lt;dbl&gt;, ...</code></pre>
<p>But that is not a good comment. If code is clearly written, it should convey <em>what</em> it is doing. The example with <code>by = &quot;Country Code&quot;</code> accomplishes that. And even unclear code, if you spend enough time working through it, you should be able to find out <em>what</em> it does. Comments should primarily be used for explainging <em>why</em> you are doing it.</p>
<pre class="r"><code># get descriptive country names for labelling plots and the income categories
left_join(wdi_data_tidy, WDI$country, by = &quot;Country Code&quot;)</code></pre>
<p>I may be able to infer why I merged country data from what I do with it later, but this is harder to understand.</p>
<ol start="6" style="list-style-type: decimal">
<li>The WDI data include “country” observations that are actually aggregations of countries, for example, “OECD members”, “High income”, “Sub-Saharan Africa (all income levels)”. Filter out those observations. Hint: there is a variable that is missing for non-countries, so you shouldn’t need to enumerate all of the non-country values.</li>
</ol>
<p>Once I realized that the WDI data included non-countries, I guessed there must be an indicator in the country data which I could use to filter out non-countries. Unforuntately, there wasn’t a variable that directly measured this. So then I started looking for variables that only make sense for countries and would be missing for the aggregates. I found that <code>Income Group</code> was missing for all the aggregates, and non missing for countries.</p>
<pre class="r"><code>filter(WDI$country, is.na(`Income Group`))[[&quot;Short Name&quot;]]</code></pre>
<pre><code>##  [1] &quot;Arab World&quot;                                        
##  [2] &quot;Central Europe and the Baltics&quot;                    
##  [3] &quot;Caribbean small states&quot;                            
##  [4] &quot;East Asia &amp; Pacific (excluding high income)&quot;       
##  [5] &quot;Early-demographic dividend&quot;                        
##  [6] &quot;East Asia &amp; Pacific&quot;                               
##  [7] &quot;Europe &amp; Central Asia (excluding high income)&quot;     
##  [8] &quot;Europe &amp; Central Asia&quot;                             
##  [9] &quot;Euro area&quot;                                         
## [10] &quot;European Union&quot;                                    
## [11] &quot;Fragile and conflict affected situations&quot;          
## [12] &quot;High income&quot;                                       
## [13] &quot;Heavily indebted poor countries (HIPC)&quot;            
## [14] &quot;IBRD only&quot;                                         
## [15] &quot;IDA &amp; IBRD total&quot;                                  
## [16] &quot;IDA total&quot;                                         
## [17] &quot;IDA blend&quot;                                         
## [18] &quot;IDA only&quot;                                          
## [19] &quot;Latin America &amp; Caribbean (excluding high income)&quot; 
## [20] &quot;Latin America &amp; Caribbean&quot;                         
## [21] &quot;Least developed countries: UN classification&quot;      
## [22] &quot;Low income&quot;                                        
## [23] &quot;Lower middle income&quot;                               
## [24] &quot;Low &amp; middle income&quot;                               
## [25] &quot;Late-demographic dividend&quot;                         
## [26] &quot;Middle East &amp; North Africa&quot;                        
## [27] &quot;Middle income&quot;                                     
## [28] &quot;Middle East &amp; North Africa (excluding high income)&quot;
## [29] &quot;North America&quot;                                     
## [30] &quot;OECD members&quot;                                      
## [31] &quot;Other small states&quot;                                
## [32] &quot;Pre-demographic dividend&quot;                          
## [33] &quot;Pacific island small states&quot;                       
## [34] &quot;Post-demographic dividend&quot;                         
## [35] &quot;South Asia&quot;                                        
## [36] &quot;Sub-Saharan Africa (excluding high income)&quot;        
## [37] &quot;Sub-Saharan Africa&quot;                                
## [38] &quot;Small states&quot;                                      
## [39] &quot;East Asia &amp; Pacific (IDA &amp; IBRD)&quot;                  
## [40] &quot;Europe &amp; Central Asia (IDA &amp; IBRD)&quot;                
## [41] &quot;Latin America &amp; Caribbean (IDA &amp; IBRD)&quot;            
## [42] &quot;Middle East &amp; North Africa (IDA &amp; IBRD)&quot;           
## [43] &quot;South Asia (IDA &amp; IBRD)&quot;                           
## [44] &quot;Sub-Saharan Africa (IDA &amp; IBRD)&quot;                   
## [45] &quot;Upper middle income&quot;                               
## [46] &quot;World&quot;</code></pre>
<p>Now that I’ve found a variable that identifies the non-countries, I can filter them out. This is a case where I’d want to make a comment in a script as to why I was doing this, because the thing I want to accomplish is not at all obvious from what I’m doing in the code. In a few months (or hours) I’d look back and wonder, why was I dropping observations with a missing income group, especially if the analysis never ends up using that variable.</p>
<pre class="r"><code>wdi_data_tidy &lt;- 
  # remove aggregate rows (e.g. Euro Area, World, etc) and
  # keep only countries. Only countries have non-missing `Income Group`
  filter(wdi_data_tidy, !is.na(`Income Group`))</code></pre>
<ol start="7" style="list-style-type: decimal">
<li><p>Choose a few variables you are interested.</p>
<ul>
<li><p>Summarize the distributions of these variables by year and income group: mean, median, min, max, standard deviation, 25th percentile, 75th percentile. Accomplish by first using <code>gather</code> to create a data frame with columns: <code>country</code>, <code>year</code>, <code>indicator</code>, and <code>value</code>. Then you can use <code>group_by()</code> and <code>summarize()</code> to summarize the data.</p></li>
<li><p>Accomplish the same task using <code>mutate_at</code> without using <code>gather</code></p></li>
<li><p>Create a line plot in which the x-axis is years, the y-axis is the mean of the indicator, each income group has its own line and a different color, and faceted by indicator. Merge the indicator level dataset in order to give the indicators meaningful labels in the plot.</p></li>
</ul></li>
</ol>
<!--
### HDI

Calculate the Human Development Indicator. The definition can be found here: http://hdr.undp.org/sites/default/files/hdr2015_technical_notes.pdf.
Check your work against example data in the documentation.
Check your work against the true values of the [Human Development Index](http://hdr.undp.org/en/data):
-->
</div>
<div id="transparency-and-missing-values" class="section level2">
<h2>Transparency and Missing Values</h2>
<p>Hollyer et al. (2011) calculates a measure of governmental transparency using the number of missing values in the WDI.<a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a> We’ll calculate something similar.</p>
<ol style="list-style-type: decimal">
<li><p>For each country-year calculate a similar figure. Calculate a similar index of missingness. Consider the following: would you use all variables? If not, how would you select those variables? Would you calculate missing values in all variables and all time periods equally?</p></li>
<li><p>Which countries are least transparent?</p></li>
<li><p>How do transparency relate to income?</p></li>
<li><p>Subset by income and plot.</p></li>
<li><p>Recently the UN released a variable on the “Overall measure of statistical capacity”. How does the (original) HRV transparency relate to that measure?</p></li>
</ol>
</div>
<div id="joining-wdi-to-vdem-data" class="section level2">
<h2>Joining WDI to VDEM data</h2>
<p>The Varieties of Democracy project is a recent project to develop indicators of democracy. We would like to merge it with the WDI indicators. Download <a href="https://www.v-dem.net/en/data/data-version-6-2/">Version 6.2</a> County-Year dataset.</p>
<ol style="list-style-type: decimal">
<li><p>What are the terms of using the data? (Why doesn’t this document include a script to automatically download it?) How do you cite the data?</p></li>
<li><p>What are the primary VDEM indices? Subset the data to include only those indices and country and year identifiers.</p></li>
<li><p>Merge the VDEM and WDI data. What does VDEM use as its country-level indicator? What does the WDI use? Note: The <strong>countrycode</strong> package may be useful here.</p></li>
<li><p>What is the relationship between democracy and transparency? What is the relationship between democracy and transparency comparing only countries within a given income level?</p></li>
</ol>
</div>
</div>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>See the <a href="http://0001c70.wcomhost.com/wp2/papers/">HRV Transparency Project</a> for more recent information on it; a 2014 paper of theirs in <em>Political Analysis</em> provides a more rigorous measure.<a href="#fnref1">↩</a></p></li>
</ol>
</div>

<p>
  Copyright Jeffrey Arnold, 2016, <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
</p>


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
